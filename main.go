package main

import (
	"fmt"
	"sync"

	_ "github.com/lib/pq"
	"github.com/spf13/viper"

	"github.com/BitDSM/BitDSM-Node/BtcDepositConfirmer"
	"github.com/BitDSM/BitDSM-Node/api"
	"github.com/BitDSM/BitDSM-Node/ethComms"
	"github.com/BitDSM/BitDSM-Node/operator"
	"github.com/BitDSM/BitDSM-Node/utils"
)

func initialize() {
	utils.InitConfigFile()
	h := "63484e6964503842414649434141414141552f6e37736e694f644e51422f474955667164354b47313071566653355a676177633761634d362f485a6b41414141414144312f2f2f2f4155676d41414141414141414667415571506f334954313537436c6b7576504e6b78635a5a6b534c716949414141414141414541665149414141414261776777614d6f4d716354466d6758755331494f3532436b525178624c70547646656f394f62696d444451414141414141502f2f2f2f38434543634141414141414141694143426c38614c35646a6a4542384277653278386d575751484e755a67627444677456666a665259337130626c48636d41414141414141414667415571506f334954313537436c6b7576504e6b78635a5a6b534c7169494141414141415145724543634141414141414141694143426c38614c35646a6a4542384277653278386d575751484e755a67627444677456666a665259337130626c4349434138736a564339706a74486d4636596a51707459585a6a376b6552494f5a536474424a724b67316163794377527a42454169425177584f70652f41684c6242564a36464c4646546545314b4455384a437341366748684838314f322b725149675644736d6e7848646b595a67364b4a62504972477a545573732b636b614b7a7a6c6364553533487655446142415156485569454479794e554c326d4f3065595870694e436d3168646d507552354567356c4a3230456d73714456707a494c4168417a6f3546744637444d304863776d4655376954735841743570656d42463439384d3570494a59482f352b775571346942674d364f52625265777a4e42334d4a68564f346b3746774c656158706752655066444f61534357422f2b667341536f2b6a63684967594479794e554c326d4f3065595870694e436d3168646d507552354567356c4a3230456d73714456707a494c415971366c414f3151414149414241414341414141416741414141414141414141414141413d"
	x, _ := utils.HexToBase64(h)
	fmt.Println(x)
	utils.LoadBtcWallet(viper.GetString("wallet_name"))
	ethAccount := ethComms.LoadEthAccount()
	fmt.Println("Eth account: ", ethAccount.Address.Hex())
	operator.RegisterOperator()
}

func main() {
	initialize()
	var wg sync.WaitGroup
	wg.Add(1)
	go api.Server()
	wg.Add(1)
	go BtcDepositConfirmer.CheckDeposit()
	wg.Add(1)
	go ethComms.SubscribeToDepositRequests()
	wg.Add(1)
	go BtcDepositConfirmer.CheckWithdraw()
	ethComms.SubscribeToWithdrawRequests()
	wg.Wait()
}
